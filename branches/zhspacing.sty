% zhspacing.sty		version 0.1
% Simple macro for typesetting mixed Chinese documents in XeTeX
%	with punctuation space adjustment and prohibitions
% coded by YIN Dian (yindian@ustc)
% Licensed under GPL
% History:	070804	First usable version.
%		070805	Several line breaking bug fixes.
%		070807	\zhinteropenskip changed to 0.6em. \enfont
%			TODO list written.
%		070808	Use macros instead of skips to fit different font size.
%		070809	Tried to use myclass to manage classes, but failed.
%			Then I found it works when \relax is added.
% TODO:
% 1. Use three skip parameters for each kind of punctuation classes.
% 2. Utilize class inheritance.
\catcode`\@=11
\ifx\zhs@defined\@undefined
\def\zhs@defined{\relax}
\XeTeXlinebreaklocale="zh"
\XeTeXlinebreakskip=0pt plus 0.2em minus 0.1em
\def\zhnobreak{\nobreak}
% my skip
\def\skipenzh{\hskip 0.25em plus 0.15em minus 0.05em}
\def\skipzhopen{\hskip -0.2em plus 0.2em minus 0.3em}
\def\skipzhinteropen{\hskip -0.5em plus 1em minus 1em}
\def\skipzhlinestartopen{\hskip -0.5em}
\def\skipzhclose{\hskip -0.2em plus 0.2em minus 0.3em}
\def\skipzhinterclose{\hskip -0.5em}
\def\skipzhlineendclose{\hskip -0.5em}
\def\skipzhjudou{\hskip -0.2em plus 0.2em minus 0.3em}
\def\skipzhinterjudou{\hskip -0.5em}
\def\skipzhlineendjudou{\hskip -0.7em}
% neg
\def\skipnegzhlinestartopen{\hskip 0.5em}
\def\skipnegzhlineendclose{\hskip 0.5em}
\def\skipnegzhlineendjudou{\hskip 0.7em}
%\let\mydbgmessage\message
\def\mydbgmessage#1{}

\input myclass.sty
% three base classes: boundary, halfwidth and fullwidth
\newclass{boundary}
\setclassnum{boundary}{255}
\newclass{halfwidth}
\newclass{fullwidth}
\setinterclasstoks{boundary}{fullwidth}{\mydbgmessage{^^JZ}\zhfont}
\setinterclasstoks{fullwidth}{boundary}{\mydbgmessage{^^Jz}\enfont\ignorespaces}
\setinterclasstoks{halfwidth}{fullwidth}{\mydbgmessage{^^JP}\zhfont}
\setinterclasstoks{fullwidth}{halfwidth}{\mydbgmessage{^^Jp}\enfont\ignorespaces}
% derived class alphanum and hanzi
\newclass[halfwidth]{alphanum}
%\setclassnum{alphanum}{0}
\newclass[fullwidth]{hanzi}
\setclassnum{hanzi}{1}
\appendinterclasstoks{alphanum}{hanzi}{\mydbgmessage{^^JQ}\skipenzh}
\prependinterclasstoks{hanzi}{alphanum}{\mydbgmessage{^^Jq}\skipenzh}
% derived class from halfwidth
%\newclass[halfwidth]{hwpunct} % (, ., etc
%\setclassnum{hwpunct}{5}
% derived class from fullwidth
\newclass[fullwidth]{openfw} % ‘, （, etc
\setclassnum{openfw}{2}
\newclass[fullwidth]{closefw} % ’, ）, etc
\setclassnum{closefw}{3}
\newclass[fullwidth]{judou} % ，, 。, etc
\setclassnum{judou}{4}
% open fullwidth punctuation after other characters
\@foreach\class\in{alphanum,hanzi,halfwidth,boundary}\do{%
  %\appendinterclasstoks{\class}{openfw}{\mydbgmessage{^^JA1}\allowbreak\skipzhopen\zhnobreak\skipnegzhlinestartopen\vadjust{}\zhnobreak\skipzhlinestartopen}
  \appendinterclasstoks{\class}{openfw}{\mydbgmessage{^^JA1}}
}
\setinterclasstoks{openfw}{openfw}{\mydbgmessage{^^JA2}\zhnobreak\skipzhinteropen}
\setinterclasstoks{closefw}{openfw}{\mydbgmessage{^^JA3}\zhnobreak\skipzhlineendclose\allowbreak\vadjust{}\skipnegzhlineendclose\skipzhinterclose\skipzhinteropen\skipnegzhlinestartopen\zhnobreak\skipzhlinestartopen}
\setinterclasstoks{judou}{openfw}{\mydbgmessage{^^JA4}\zhnobreak\skipzhlineendjudou\allowbreak\vadjust{}\skipnegzhlineendjudou\skipzhinterjudou\skipzhinteropen\skipnegzhlinestartopen\zhnobreak\skipzhlinestartopen}
%\setinterclasstoks{openfw}{openfw}{\mydbgmessage{^^JA2}}
%\setinterclasstoks{closefw}{openfw}{\mydbgmessage{^^JA3}}
%\setinterclasstoks{judou}{openfw}{\mydbgmessage{^^JA4}}
% close fullwidth punctuation before other characters
\@foreach\class\in{alphanum,hanzi,halfwidth,boundary}\do{%
  %\appendinterclasstoks{closefw}{\class}{\mydbgmessage{^^JB1}\zhnobreak\skipzhlineendclose\allowbreak\skipnegzhlineendclose\skipzhclose}
  \appendinterclasstoks{closefw}{\class}{\mydbgmessage{^^JB1}}
}
\setinterclasstoks{closefw}{closefw}{\mydbgmessage{^^JB2}\zhnobreak\skipzhinterclose}
\setinterclasstoks{closefw}{judou}{\mydbgmessage{^^JB3}\zhnobreak\skipzhinterclose}
%\setinterclasstoks{closefw}{closefw}{\mydbgmessage{^^JB2}}
%\setinterclasstoks{closefw}{judou}{\mydbgmessage{^^JB3}}
% judou punctuation before other characters
\@foreach\class\in{alphanum,hanzi,halfwidth,boundary}\do{%
  %\appendinterclasstoks{judou}{\class}{\mydbgmessage{^^JC1}\zhnobreak\skipzhlineendjudou\allowbreak\skipnegzhlineendjudou\skipzhjudou}
  \appendinterclasstoks{judou}{\class}{\mydbgmessage{^^JC1}}
}
\setinterclasstoks{judou}{judou}{\mydbgmessage{^^JC2}\zhnobreak\skipzhinterjudou}
%\setinterclasstoks{judou}{judou}{\mydbgmessage{^^JC2}}
% open fullwidth punctuation before other characters
\@foreach\class\in{alphanum,hanzi,halfwidth,boundary,closefw,judou}\do{%
  \appendinterclasstoks{openfw}{\class}{\mydbgmessage{^^Ja}\zhnobreak}
}
% close fullwidth punctuation after other characters
\@foreach\class\in{alphanum,hanzi,halfwidth,boundary}\do{%
  \appendinterclasstoks{\class}{closefw}{\mydbgmessage{^^Jb}\zhnobreak}
}
\setinterclasstoks{judou}{closefw}{\mydbgmessage{^^Jb2}\zhnobreak\skipzhinterjudou}
% judou punctuation after other characters
\@foreach\class\in{alphanum,hanzi,halfwidth,boundary}\do{%
  \appendinterclasstoks{\class}{judou}{\mydbgmessage{^^Jc}\zhnobreak}
}

\prependinterclasstoks{boundary}{openfw}{\mydbgmessage{^^J*}}


\def\zhspacing{%
  \XeTeXcharclass`：=4
  \XeTeXcharclass`，=4
  \XeTeXcharclass`、=4
  \XeTeXcharclass`。=4
  \XeTeXcharclass`．=4
  \XeTeXcharclass`“=2
  \XeTeXcharclass`”=3
  \XeTeXcharclass`‘=2
  \XeTeXcharclass`’=3
  \XeTeXcharclass`—=5
  \XeTeXcharclass`…=5
  \registerXeTeXclasstoks
  %\XeTeXcharclass 255 1={}
  %\XeTeXcharclass 1 255={}
  %\XeTeXcharclass 1 1={}
  \XeTeXinterchartokenstate=1
  \zhfont
  \parindent=2em
  \enfont
  \mydbgmessage{zhspacing installed.^^J}
}
\fi
